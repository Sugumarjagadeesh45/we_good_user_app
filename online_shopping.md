# Online Shopping Module Documentation

## ðŸš¨ CRITICAL: If Getting 500 Error on Order Creation

**See**: [BACKEND_ORDER_FIX.md](BACKEND_ORDER_FIX.md) for complete backend fix with detailed implementation guide.

**Quick Summary**:
- The backend `createOrder` function in `/controllers/orderController.js` needs to be complete
- Missing orderId generation, product validation, and proper error handling
- Follow the complete implementation in BACKEND_ORDER_FIX.md

---

## Overview

This document provides comprehensive documentation for the **Online Shopping** feature in the Eazygo app. This module allows users to browse products, manage shopping cart, add delivery addresses, and place orders.

---

## Backend Configuration

### Base URL

**Development (Local via Ngrok)**:
```
https://a6edc4973eae.ngrok-free.app
```

**Important**: Update this URL in the following files whenever you restart ngrok:
- `src/socket.ts`
- `src/util/backendConfig.tsx`

All shopping-related API calls use the `getBackendUrl()` function from `src/util/backendConfig.tsx`.

---

## API Endpoints

### Product Management

#### Get All Products
```http
GET /api/products
Query Parameters:
  - category (optional): Filter by category (e.g., "Vegetables", "Fruits")
  - search (optional): Search by product name

Response:
{
  "success": true,
  "data": [
    {
      "_id": "product_id",
      "productId": 1,
      "name": "Product Name",
      "description": "Product description",
      "price": 100.00,
      "originalPrice": 150.00,
      "discount": 33,
      "category": "Category Name",
      "stock": 50,
      "images": ["url1", "url2"],
      "status": "available",
      "isActive": true
    }
  ]
}
```

#### Get Product Categories
```http
GET /api/products/categories

Response:
{
  "success": true,
  "data": ["Vegetables", "Fruits", "Dairy", "Snacks", ...]
}
```

#### Add Product (Admin)
```http
POST /api/products
Headers:
  Authorization: Bearer {admin_token}
  Content-Type: multipart/form-data

Body (FormData):
  - name: string (required)
  - description: string (required)
  - price: number (required)
  - originalPrice: number (optional)
  - discount: number (optional)
  - category: string (required)
  - stock: number (optional, default: 0)
  - images: File[] (multiple image files)

Response:
{
  "success": true,
  "message": "Product added successfully",
  "data": {product_object}
}
```

#### Update Product (Admin)
```http
PUT /api/products/:id
Headers:
  Authorization: Bearer {admin_token}
  Content-Type: multipart/form-data

Body: Same as Add Product

Response:
{
  "success": true,
  "message": "Product updated successfully",
  "data": {updated_product}
}
```

#### Delete Product (Admin)
```http
DELETE /api/products/:id
Headers:
  Authorization: Bearer {admin_token}

Response:
{
  "success": true,
  "message": "Product deleted successfully"
}
```

#### Update Product Stock
```http
POST /api/products/update-stock
Headers:
  Authorization: Bearer {token}

Body:
{
  "productId": number,
  "quantity": number
}

Response:
{
  "success": true,
  "message": "Stock updated successfully",
  "data": {updated_product}
}
```

---

### Order Management

#### Create Order
```http
POST /api/orders/create
Headers:
  Authorization: Bearer {user_token}
  Content-Type: application/json

Body:
{
  "userId": "user_mongodb_id",
  "customerId": "100063", // User's customerId (required)
  "products": [
    {
      "_id": "product_id",
      "productId": "product_id",
      "name": "Product Name",
      "price": 100.00,
      "quantity": 2,
      "images": ["url1"],
      "category": "Category Name"
    }
  ],
  "deliveryAddress": {
    "name": "Customer Name",
    "phone": "9876543210",
    "addressLine1": "House No, Street",
    "addressLine2": "Landmark",
    "city": "City",
    "state": "State",
    "pincode": "123456",
    "country": "India",
    "isDefault": true
  },
  "paymentMethod": "cash" | "upi" | "card" | "wallet",
  "totalAmount": 250.88,
  "subtotal": 200.00,
  "shipping": 40.00,
  "tax": 10.88,
  "orderDate": "2026-01-13T09:46:35.764Z",
  "useWallet": false
}

Response (Success):
{
  "success": true,
  "message": "Order placed successfully",
  "data": {
    "orderId": "ORD-20260113-001",
    "customerId": "100063",
    "status": "order_confirmed",
    "totalAmount": 250.88,
    ...order_details
  }
}

Response (Error):
{
  "success": false,
  "error": "Error message",
  "details": "Detailed error description"
}
```

**Important Notes**:
- `customerId` is **required** and must match the user's customerId from Registration model
- `userId` should be the MongoDB `_id` of the user
- If user doesn't have a customerId, it will be auto-generated by the backend
- Products array must contain valid product objects with all required fields

#### Get Customer Orders
```http
GET /api/orders/customer/:userId
Headers:
  Authorization: Bearer {user_token}

Response:
{
  "success": true,
  "data": [
    {
      "_id": "order_mongodb_id",
      "orderId": "ORD-20260113-001",
      "customerId": "100063",
      "status": "order_confirmed" | "processing" | "packed" | "shipped" | "out_for_delivery" | "delivered" | "cancelled",
      "totalAmount": 250.88,
      "subtotal": 200.00,
      "shipping": 40.00,
      "tax": 10.88,
      "products": [...],
      "deliveryAddress": {...},
      "paymentMethod": "cash",
      "orderDate": "2026-01-13T09:46:35.764Z",
      "createdAt": "2026-01-13T09:46:35.764Z",
      "updatedAt": "2026-01-13T09:46:35.764Z"
    }
  ],
  "message": "Found X orders"
}
```

#### Get Orders by Customer ID
```http
GET /api/orders/by-customer/:customerId
Headers:
  Authorization: Bearer {user_token}

Response: Same as Get Customer Orders
```

#### Update Order Status (Admin)
```http
PATCH /api/orders/:orderId/status
Headers:
  Authorization: Bearer {admin_token}

Body:
{
  "status": "order_confirmed" | "processing" | "packed" | "shipped" | "out_for_delivery" | "delivered" | "cancelled"
}

Response:
{
  "success": true,
  "message": "Order status updated successfully",
  "data": {
    "orderId": "ORD-20260113-001",
    "status": "shipped"
  }
}
```

#### Get All Orders (Admin)
```http
GET /api/orders
Headers:
  Authorization: Bearer {admin_token}

Query Parameters:
  - page: number (default: 1)
  - limit: number (default: 10)
  - status: string (optional, filter by status)

Response:
{
  "success": true,
  "data": [...orders],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalOrders": 50,
    "hasNextPage": true,
    "hasPrevPage": false
  }
}
```

#### Get Order Statistics (Admin)
```http
GET /api/orders/stats
Headers:
  Authorization: Bearer {admin_token}

Response:
{
  "success": true,
  "data": {
    "totalOrders": 150,
    "deliveredOrders": 100,
    "pendingOrders": 50,
    "totalRevenue": 25000.00,
    "avgOrderValue": 250.00,
    "customerCount": 75
  }
}
```

#### Test Order Service Connection
```http
GET /api/orders/test-connection

Response:
{
  "success": true,
  "message": "Orders API is connected!",
  "timestamp": "2026-01-13T09:46:43.322Z"
}
```

---

### Address Management

**Note**: Addresses are currently stored locally in AsyncStorage. Backend endpoints exist but are not actively used by the app.

#### Local Storage Key
```
'shippingAddress' - Stores the default delivery address
```

**Address Structure**:
```typescript
{
  id: string,
  name: string,
  phone: string,
  addressLine1: string,
  addressLine2?: string,
  city: string,
  state: string,
  pincode: string,
  country: string,
  isDefault: boolean,
  latitude?: number,
  longitude?: number
}
```

---

## Frontend Components

### Shopping Module Structure

```
src/Screen1/Shopping/
â”œâ”€â”€ ShoppingContent.tsx           # Main shopping interface & CartProvider
â”œâ”€â”€ BuyNow.tsx                    # Cart checkout page
â”œâ”€â”€ EnhancedCheckout.tsx          # Enhanced checkout flow
â”œâ”€â”€ EnhancedCart.tsx              # Detailed cart management
â”œâ”€â”€ EnhancedMyOrders.tsx          # Order history
â”œâ”€â”€ AddressManagement.tsx         # Address CRUD interface
â”œâ”€â”€ AddressContext.tsx            # Address state management
â””â”€â”€ icons/
    â””â”€â”€ Cart.tsx                  # Cart icon with badge counter
```

### Key Context Providers

#### CartProvider (in ShoppingContent.tsx)
```typescript
const CartContext = createContext({
  cartItems: [],
  addToCart: (product) => {},
  removeFromCart: (productId) => {},
  updateQuantity: (productId, quantity) => {},
  clearCart: () => {},
  getCartTotal: () => number,
  getCartItemsCount: () => number
});
```

#### AddressProvider (AddressContext.tsx)
```typescript
const AddressContext = createContext({
  addresses: [],
  defaultAddress: null,
  addAddress: (address) => Promise<void>,
  updateAddress: (id, address) => Promise<void>,
  deleteAddress: (id) => Promise<void>,
  setDefaultAddress: (id) => Promise<void>,
  fetchAddresses: () => Promise<void>,
  fetchUserProfileForAddress: () => Promise<void>,
  loading: boolean
});
```

---

## Data Models

### Product Model (Backend)
```javascript
{
  productId: Number (auto-generated),
  name: String (required),
  description: String (required),
  price: Number (required),
  originalPrice: Number,
  discount: Number,
  category: String (required),
  stock: Number (default: 0),
  images: [String],
  status: String (default: 'available'),
  isActive: Boolean (default: true),
  createdAt: Date,
  updatedAt: Date
}
```

### Order Model (Backend)
```javascript
{
  orderId: String (auto-generated, format: ORD-YYYYMMDD-XXX),
  customerId: String (required, from Registration.customerId),
  user: ObjectId (ref: 'Registration'),
  customerName: String,
  customerPhone: String,
  customerEmail: String,
  customerAddress: String,
  products: [{
    _id: String,
    productId: String,
    name: String,
    price: Number,
    quantity: Number,
    images: [String],
    category: String,
    description: String
  }],
  deliveryAddress: {
    name: String,
    phone: String,
    addressLine1: String,
    addressLine2: String,
    city: String,
    state: String,
    pincode: String,
    country: String,
    isDefault: Boolean
  },
  totalAmount: Number (required),
  subtotal: Number,
  shipping: Number,
  tax: Number,
  status: String (default: 'order_confirmed'),
  paymentMethod: String (default: 'cash'),
  orderDate: Date,
  createdAt: Date,
  updatedAt: Date
}
```

### Registration Model (User) - Shopping Related Fields
```javascript
{
  _id: ObjectId,
  customerId: String (format: "100XXX", auto-generated),
  name: String,
  phoneNumber: String,
  email: String,
  address: String,
  altMobile: String,
  profilePicture: String,
  wallet: {
    balance: Number,
    currency: String,
    transactions: [ObjectId]
  }
}
```

---

## Order Status Flow

```
order_confirmed â†’ processing â†’ packed â†’ shipped â†’ out_for_delivery â†’ delivered
                                                   â†“
                                               cancelled
```

**Status Descriptions**:
- `order_confirmed`: Order has been placed and confirmed
- `processing`: Order is being prepared
- `packed`: Order has been packed and ready for dispatch
- `shipped`: Order has been dispatched from warehouse
- `out_for_delivery`: Order is out for delivery to customer
- `delivered`: Order has been successfully delivered
- `cancelled`: Order has been cancelled

---

## Important Implementation Notes

### 1. Customer ID Requirement
- Every user must have a `customerId` field in their Registration document
- CustomerId format: `100XXX` (starting from 100000)
- If a user doesn't have a customerId, the backend will auto-generate one during order creation
- Orders are linked to users via both `userId` (MongoDB _id) and `customerId`

### 2. Image URL Handling
All product images are handled through the `getImageUrl()` function from `backendConfig.tsx`:
```typescript
import { getImageUrl } from '../../util/backendConfig';

const imageUrl = getImageUrl(product.images[0]);
```

This function:
- Fixes localhost URLs from database to use ngrok URL
- Handles multiple path formats (`/uploads/`, `uploads/`, or plain filenames)
- Provides fallback to placeholder for missing images

### 3. Authentication
All API calls require authentication via Bearer token:
```typescript
const token = await AsyncStorage.getItem('userToken') || await AsyncStorage.getItem('authToken');

axios.get(url, {
  headers: { Authorization: `Bearer ${token}` }
});
```

### 4. Cart Management
- Cart data is stored locally in component state (CartProvider)
- Cart persists during the session but clears after order placement
- Cart items include: product details, quantity, price, images

### 5. Address Management
- Addresses are stored locally in AsyncStorage
- Default address is automatically created from user profile
- Users can add multiple addresses and set one as default

### 6. Order Calculations
```typescript
Subtotal = Sum of (product.price Ã— product.quantity)
Shipping = Fixed fee (e.g., â‚¹40.00)
Tax = (Subtotal + Shipping) Ã— tax_rate (e.g., 5%)
Total = Subtotal + Shipping + Tax
```

---

## Error Handling

### Common Errors

#### 500 Internal Server Error (Order Creation)
**Causes**:
- Missing customerId in user profile
- Invalid product data structure
- Database connection issues

**Solutions**:
- Ensure user has customerId in Registration model
- Validate all required fields before sending request
- Check backend logs for specific error details

#### 404 Not Found
**Causes**:
- Incorrect API endpoint
- Backend service not running
- Wrong ngrok URL

**Solutions**:
- Verify ngrok URL is updated in `socket.ts` and `backendConfig.tsx`
- Ensure backend server is running on localhost:5001
- Check if ngrok tunnel is active

#### Authentication Errors (401/403)
**Causes**:
- Missing or expired token
- Invalid token format

**Solutions**:
- Re-login to get fresh token
- Check token is stored correctly in AsyncStorage
- Verify token is sent in Authorization header

---

## Testing Checklist

### Product Browsing
- [ ] Products load correctly with images
- [ ] Category filtering works
- [ ] Search functionality works
- [ ] Product details display correctly

### Cart Management
- [ ] Add to cart works
- [ ] Update quantity works
- [ ] Remove from cart works
- [ ] Cart badge shows correct count
- [ ] Cart total calculates correctly

### Address Management
- [ ] Can add new address
- [ ] Can edit existing address
- [ ] Can delete address (except last one)
- [ ] Can set default address
- [ ] Default address auto-loads from profile

### Order Placement
- [ ] Order creation succeeds
- [ ] CustomerId is included in order
- [ ] Order confirmation alert shows
- [ ] Cart clears after successful order
- [ ] Can navigate to order history

### Order History
- [ ] Orders load for logged-in user
- [ ] Order details display correctly
- [ ] Order status updates show
- [ ] Product images display in orders

---

## Backend Controller Files (Reference)

### Product Controller
**File**: `/controllers/groceryController.js`

**Key Functions**:
- `getProducts` - Fetch all products with filters
- `addProduct` - Add new product (admin)
- `updateProduct` - Update existing product (admin)
- `deleteProduct` - Delete product (admin)
- `getCategories` - Get all product categories
- `updateStock` - Update product stock

### Order Controller
**File**: `/controllers/orderController.js`

**Key Functions**:
- `createOrder` - Create new order
- `getCustomerOrders` - Get orders by userId
- `getOrdersByCustomerId` - Get orders by customerId
- `updateOrderStatus` - Update order status (admin)
- `getAllOrders` - Get all orders with pagination (admin)
- `getOrderStats` - Get order statistics (admin)

---

## Database Models (Reference)

### Product Model
**File**: `/models/Product.js`

### Order Model
**File**: `/models/Order.js`

### Registration Model (User)
**File**: `/models/user/Registration.js`

---

## Configuration Requirements

### Backend Requirements
1. MongoDB connection must be active
2. Server running on `localhost:5001`
3. Ngrok tunnel forwarding to `localhost:5001`
4. Image upload directory: `/uploads/` (must be publicly accessible)

### Frontend Requirements
1. React Native environment setup
2. AsyncStorage for local data persistence
3. Axios for HTTP requests
4. React Navigation for screen navigation
5. Context API for state management

---

## Future Enhancements

### Planned Features
- [ ] Product reviews and ratings
- [ ] Wishlist functionality
- [ ] Order tracking with real-time updates
- [ ] Push notifications for order updates
- [ ] Multiple payment gateway integration
- [ ] Wallet payment support
- [ ] Coupon and discount codes
- [ ] Product recommendations
- [ ] Order cancellation from app
- [ [ Return and refund management

### Backend API Improvements Needed
- [ ] Implement proper address API endpoints
- [ ] Add pagination for products
- [ ] Add image compression during upload
- [ ] Implement product search with Elasticsearch
- [ ] Add inventory management system
- [ ] Implement order tracking system
- [ ] Add email notifications for orders
- [ ] SMS notifications for order updates

---

## Troubleshooting Guide

### Issue: Products not loading
**Solution**:
1. Check ngrok URL is correct
2. Verify backend is running
3. Check product collection has data
4. Check network connection

### Issue: Order creation fails with 500 error
**Solution**:
1. Verify user has customerId in database
2. Check all required fields are present in request
3. Verify MongoDB connection
4. Check backend logs for specific error

### Issue: Images not displaying
**Solution**:
1. Verify image URLs are correct
2. Check ngrok tunnel is active
3. Ensure uploads directory is publicly accessible
4. Check `getImageUrl()` function is being used

### Issue: Address not saving
**Solution**:
1. Check AddressContext provider is wrapping the app
2. Verify AsyncStorage permissions
3. Check form validation is passing
4. Ensure all required fields are filled

---

## Support and Maintenance

### Log Locations
- Backend logs: Console output from Node.js server
- Frontend logs: React Native debugger console
- Network logs: React Native Debugger Network tab

### Debug Mode
Enable detailed logging by checking console logs in:
- `BuyNow.tsx` - Order creation flow
- `AddressContext.tsx` - Address management
- `backendConfig.tsx` - Image URL handling

### Contact
For backend issues, check:
- MongoDB connection status
- Node.js server logs
- Ngrok tunnel status
- API endpoint availability

---

**Last Updated**: 2026-01-13
**Version**: 1.0
**Status**: Production Ready
